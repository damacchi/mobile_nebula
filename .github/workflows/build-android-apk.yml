name: Build Android APK for Manual Install

# Only allow manual triggering from GitHub UI
on:
  workflow_dispatch: # Allows manual trigger from Actions tab

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest # Using Ubuntu instead of macOS for faster/cheaper builds

    steps:
      # Step 1: Download the repository code
      - name: Check out code
        uses: actions/checkout@v4

      # Step 2: Apply a temporary Go patch (remove when fix is in mainline)
      # TODO: remove when https://go-review.googlesource.com/c/go/+/692935 lands in mainline go
      - name: Patch Go
        uses: DefinedNet/patch-go@c8e4a17c75eb242d34c212419d7d3d25e8d58949
        with:
          patch-ref: "296be05a97eb526dc0e438b7387670d4cae4a935"

      # Step 3: Install Java 17 (required for Android builds)
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      # Step 4: Install Flutter framework at specific version
      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.2"

      # Step 5: Install Go mobile tools and Flutter dependencies
      - name: Get dependencies
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest  # Install gomobile for Go-based Android libs
          gomobile init  # Initialize gomobile
          flutter pub get  # Download Flutter package dependencies
          touch env.sh  # Create empty env.sh file (required by build process)

      # Step 6: Build debug APK (automatically signed with debug key)
      # Debug APKs can be installed directly on any Android device
      - name: Build Android Debug APK
        run: |
          flutter build apk --debug

      # Step 7: Upload the APK as a downloadable artifact
      # You can download this from the Actions run page for 30 days
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: MobileNebula-debug-${{ github.sha }}.apk # Include commit hash in filename
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30 # Keep artifact for 30 days
